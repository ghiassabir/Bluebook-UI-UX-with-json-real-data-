<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluebook Prototype - Phase 5 (Real Data P2 - Corrected)</title>
    <style>
        :root {
            --bluebook-dark-blue: #0d2f5a;
            --bluebook-header-blue-home: #003366;
            --bluebook-footer-blue: #e0e7ff;
            --bluebook-button-blue: #2563eb;
            --bluebook-button-secondary-bg: #1e293b;
            --bluebook-border-color: #cbd5e0;
            --bluebook-text-color: #1e293b;
            --bluebook-light-text: #64748b;
            --bluebook-selected-blue-border: #2563eb;
            --bluebook-selected-blue-bg: #eff6ff;
            --bluebook-option-letter-border: #94a3b8;
            --bluebook-option-letter-text: #475569;
            --bluebook-preview-banner-bg: #334155;
            --bluebook-pane-divider: #cbd5e0;
            --bluebook-yellow-button: #facc15;
            --bluebook-yellow-button-hover: #eab308;
            --bluebook-yellow-button-text: #422006;
            --bluebook-red-flag: #ef4444;
            --bluebook-dim-text: #9ca3af;
            --bluebook-crossout-btn-bg-active: #dbeafe;
            --bluebook-highlight-yellow: #fef9c3;
            --bluebook-spr-input-bg: #ffffff;
            --bluebook-spr-input-border: #6b7280;
            --bluebook-home-bg: #f0f4f8;
            --bluebook-card-bg: #ffffff;
        }

        body, html {
            margin: 0; padding: 0; height: 100%; font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; color: var(--bluebook-text-color);
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
            overflow: hidden;
        }

        .app-view {
            display: none; flex-direction: column;
            height: 100%; width: 100%; position: absolute;
            top: 0; left: 0;
        }
        .app-view.active { display: flex; }

        /* --- Test Interface & Review Page Common Header Styles --- */
        .test-interface-view .app-header, .review-page-view .app-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 1rem; background-color: var(--bluebook-dark-blue); color: white;
            height: 50px; flex-shrink: 0; z-index: 10;
        }
        .test-interface-view .header-left, .test-interface-view .header-center, .test-interface-view .header-right,
        .review-page-view .header-left, .review-page-view .header-center, .review-page-view .header-right {
             display: flex; align-items: center; gap: 1rem;
        }
        .test-interface-view .header-center, .review-page-view .header-center { position: absolute; left: 50%; transform: translateX(-50%); }

        .directions-btn {
            display: flex; align-items: center; gap: 0.25rem; cursor: pointer;
            color: #d1d5db; font-size: 0.875rem;
        }
        .directions-btn:hover { color: white; }
        .directions-btn svg { width: 0.875rem; height: 0.875rem; }

        .section-title-header { font-size: 0.875rem; font-weight: 600; }

        .timer-display-container {
            display: flex; align-items: center;
            background-color: rgba(0,0,0,0.2); padding: 0.25rem 0.75rem; border-radius: 9999px;
        }
        .timer-text { font-size: 0.875rem; font-weight: 500; }
        .timer-text.hidden { display: none; }
        .timer-icon { width: 0.875rem; height: 0.875rem; color: white; }
        .timer-icon.hidden { display: none; }
        .timer-toggle { font-size: 0.75rem; color: #9ca3af; cursor: pointer; margin-left: 0.25rem; }
        .timer-toggle:hover { color: white; }

        .header-icon-btn {
            display: flex; align-items: center; gap: 0.375rem; color: #d1d5db;
            font-size: 0.8125rem; cursor: pointer; position: relative;
            padding: 0.25rem 0.375rem;
        }
        .header-icon-btn:hover { color: white; }
        .header-icon-btn.active { color: white; background-color: rgba(255,255,255,0.1); border-radius: 0.25rem;}
        .header-icon-btn svg { width: 1rem; height: 1rem; }
        .header-icon-btn.hidden { display: none !important; }


        .test-preview-banner {
            background-color: var(--bluebook-preview-banner-bg); color: white; text-align: center;
            padding: 0.125rem 0; font-size: 0.75rem; font-weight: bold;
            letter-spacing: 0.05em; flex-shrink: 0;
        }
        .main-content-area { display: flex; flex-grow: 1; overflow: hidden; }
        .main-content-area.cross-out-active .answer-option:not(.crossed-out) { cursor: default; }
        .main-content-area.highlight-active .passage-content { cursor: text; }


        .main-content-area.single-pane .passage-pane,
        .main-content-area.single-pane .spr-instructions-pane,
        .main-content-area.single-pane .pane-divider-draggable { display: none !important; }
        .main-content-area.single-pane .question-pane { flex-basis: 100% !important; max-width: 100% !important; }

        /* Default two-pane for R&W with passage */
        .main-content-area .passage-pane { flex-basis: 50%; border-right: 1px solid var(--bluebook-pane-divider); display: flex; /* Changed to flex */ flex-direction: column; }
        .main-content-area .question-pane { flex-basis: 50%; }
        .main-content-area .pane-divider-draggable { display: block; }
        .main-content-area .spr-instructions-pane { display: none; }


        /* Layout for SPR questions */
        .main-content-area.two-pane-spr .passage-pane { display: none !important; }
        .main-content-area.two-pane-spr .spr-instructions-pane { display: flex !important; flex-direction: column; flex-basis: 50%; border-right: 1px solid var(--bluebook-pane-divider); }
        .main-content-area.two-pane-spr .question-pane { flex-basis: 50%; }
        .main-content-area.two-pane-spr .pane-divider-draggable { display: block !important; }


        .passage-pane, .question-pane, .spr-instructions-pane {
            padding: 1.5rem; overflow-y: auto; box-sizing: border-box; background-color: white;
        }
        /* .passage-pane { flex-basis: 50%; border-right: 1px solid var(--bluebook-pane-divider); } Managed by layout classes */
        /* .spr-instructions-pane { flex-basis: 50%; border-right: 1px solid var(--bluebook-pane-divider); display: none; } Managed by layout classes */
        /* .question-pane { flex-basis: 50%; background-color: #f9fafb; } Managed by layout classes */

        .passage-content p, .question-text p, .spr-instructions-content p, .spr-instructions-content li { font-size: 1rem; line-height: 1.6; }
        .passage-content p + p, .spr-instructions-content p + p { margin-top: 1em; }
         .spr-instructions-content h3 { font-size: 1.125rem; font-weight: bold; margin-bottom: 0.75rem;}
        .spr-instructions-content ul { list-style-position: outside; padding-left: 1.5rem; margin-bottom: 1rem;}
        .spr-instructions-content ul li { margin-bottom: 0.5rem; }
        .spr-examples-table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; font-size: 0.875rem; }
        .spr-examples-table th, .spr-examples-table td { border: 1px solid var(--bluebook-border-color); padding: 0.5rem; text-align: left; }
        .spr-examples-table th { background-color: #f3f4f6; font-weight: 600; }
        .pane-divider-draggable { width: 2px; background-color: var(--bluebook-pane-divider); cursor: col-resize; flex-shrink: 0; }
        .question-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px dashed var(--bluebook-border-color);
            padding-bottom: 0.75rem; margin-bottom: 1.25rem;
        }
        .question-ident { display: flex; align-items: center; gap: 0.75rem; }
        .question-number-box {
            width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center;
            background-color: var(--bluebook-text-color); color: white;
            border-radius: 0.375rem; font-weight: bold; font-size: 0.875rem;
        }
        .mark-for-review-label {
            display: flex; align-items: center; gap: 0.5rem;
            font-size: 0.875rem; color: var(--bluebook-light-text); cursor: pointer;
        }
        .mark-for-review-label input { display: none; }
        .mark-for-review-label svg { width: 1.25rem; height: 1.25rem; color: #9ca3af; }
        .mark-for-review-label input:checked + svg { color: var(--bluebook-red-flag); fill: var(--bluebook-red-flag); }
        .cross-out-tool-btn {
            border: 1px solid var(--bluebook-border-color); border-radius: 0.375rem;
            padding: 0.5rem; cursor: pointer; background-color: white;
            display: flex; align-items: center; gap: 0.25rem;
        }
        .cross-out-tool-btn:hover { background-color: #f3f4f6; }
        .cross-out-tool-btn.active { background-color: var(--bluebook-crossout-btn-bg-active); border-color: var(--bluebook-button-blue); }
        .cross-out-tool-btn svg { width: 1.5rem; height: 1.5rem; }
        .answer-options { display: flex; flex-direction: column; gap: 0.75rem; }
        .answer-option-container { display: flex; align-items: center; gap: 0.5rem; }
        .answer-option {
            flex-grow: 1; display: flex; align-items: center; padding: 0.75rem;
            border: 1px solid var(--bluebook-border-color); border-radius: 0.5rem;
            cursor: pointer; background-color: white; gap: 0.75rem; position: relative;
        }
        .answer-option:hover:not(.crossed-out) { border-color: #a5b4fc; }
        .answer-option.selected:not(.crossed-out) {
            border-color: var(--bluebook-selected-blue-border);
            background-color: var(--bluebook-selected-blue-bg);
            box-shadow: 0 0 0 1px var(--bluebook-selected-blue-border);
        }
        .answer-option.crossed-out { cursor: default !important; }
        .answer-option.crossed-out .answer-text, .answer-option.crossed-out .answer-letter { color: var(--bluebook-dim-text) !important; }
        .answer-option.crossed-out .answer-letter { border-color: var(--bluebook-dim-text) !important; background-color: #e5e7eb !important; }
        .answer-option.crossed-out::after {
            content: ''; position: absolute; left: 0.75rem; right: 0.75rem; top: 50%;
            height: 2px; background-color: var(--bluebook-dim-text);
            transform: translateY(-50%); z-index: 1;
        }
        .answer-letter {
            width: 1.75rem; height: 1.75rem; border-radius: 9999px;
            border: 1px solid var(--bluebook-option-letter-border); color: var(--bluebook-option-letter-text);
            display: flex; justify-content: center; align-items: center;
            font-weight: 600; font-size: 0.875rem; flex-shrink: 0;
            position: relative; z-index: 2; 
        }
        .answer-option.selected:not(.crossed-out) .answer-letter { background-color: var(--bluebook-selected-blue-border); color: white; border-color: var(--bluebook-selected-blue-border); }
        .answer-text { font-size: 1rem; color: var(--bluebook-text-color); position: relative; z-index: 2; flex-grow: 1; }
        .answer-text.text-dimmed-for-crossout { color: var(--bluebook-dim-text) !important; }
        .individual-cross-out-btn {
            width: 1.5rem; height: 1.5rem; display: flex; align-items: center; justify-content: center;
            border: 1px solid var(--bluebook-border-color); border-radius: 50%;
            background-color: white; color: var(--bluebook-light-text);
            cursor: pointer; flex-shrink: 0; visibility: hidden;
        }
        .main-content-area.cross-out-active .answer-option-container .individual-cross-out-btn { visibility: visible; }
        .main-content-area.cross-out-active .answer-option-container:has(.answer-option.crossed-out) .individual-cross-out-btn { 
             display: none !important; 
        }
        .individual-cross-out-btn:hover { background-color: #f3f4f6; color: var(--bluebook-text-color); }
        .undo-cross-out-btn {
            font-size: 0.875rem; color: var(--bluebook-button-blue);
            font-weight: 500; cursor: pointer; text-decoration: underline;
            padding-left: 0.5rem; flex-shrink: 0;
        }
        .spr-input-container { margin-top: 1.5rem; }
        .spr-input-field {
            width: 180px; padding: 0.75rem; font-size: 1.5rem; text-align: center;
            border: 2px solid var(--bluebook-spr-input-border); border-radius: 0.375rem;
            background-color: var(--bluebook-spr-input-bg); color: var(--bluebook-text-color);
        }
        .spr-input-field:focus { outline: 2px solid var(--bluebook-button-blue); border-color: var(--bluebook-button-blue); }
        .spr-answer-preview { margin-top: 0.75rem; font-style: italic; color: var(--bluebook-light-text); font-size: 0.875rem; height: 1.25em; }
        .text-highlight { background-color: var(--bluebook-highlight-yellow); }
        .calculator-overlay {
            position: fixed; top: 100px; left: 100px; width: 380px; min-height: 450px;
            background-color: #ffffff; border: 1px solid #ccc; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 60;
            display: none; flex-direction: column;
        }
        .calculator-overlay.visible { display: flex; }
        .calculator-header {
            padding: 0.5rem 0.75rem; background-color: #f1f1f1; cursor: move;
            border-bottom: 1px solid #ccc; border-top-left-radius: 7px; border-top-right-radius: 7px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .calculator-header strong { font-weight: 600; font-size: 0.875rem; }
        .calculator-close-btn { cursor: pointer; border: none; background: none; font-size: 1.5rem; color: var(--bluebook-light-text); padding: 0 0.25rem; }
        .calculator-close-btn:hover { color: var(--bluebook-text-color); }
        .calculator-body {
            flex-grow: 1; display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem; color: #aaa; padding: 1rem;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm72 0c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm0 36c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-72 0c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zM47 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm0 36c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zM11 54c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm72 0c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7z' stroke-width='1' stroke='%23CCC' fill-opacity='0.1' fill='%23EEE'/%3E%3C/svg%3E");
        }
        .reference-sheet-panel {
            position: fixed; top: 0; right: 0; width: 350px; height: 100%;
            background-color: #f8f9fa; z-index: 55;
            box-shadow: -3px 0 10px rgba(0,0,0,0.1);
            transform: translateX(100%); transition: transform 0.3s ease-in-out;
            display: flex; flex-direction: column;
            border-left: 1px solid var(--bluebook-border-color);
        }
        .reference-sheet-panel.visible { transform: translateX(0); }
        .reference-header {
            padding: 1rem 1.25rem; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--bluebook-border-color); background-color: #eff2f5;
        }
        .reference-header h3 { font-size: 1rem; font-weight: 600; margin: 0; color: var(--bluebook-text-color); }
        .reference-close-btn { cursor: pointer; border: none; background: none; font-size: 1.75rem; color: var(--bluebook-light-text); padding: 0 0.25rem; }
        .reference-close-btn:hover { color: var(--bluebook-text-color); }
        .reference-body { padding: 1.25rem; overflow-y: auto; flex-grow: 1; }
        .reference-body img { max-width: 100%; height: auto; }

        /* Footer common styles for test & review */
        .app-footer {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.5rem 1rem; background-color: var(--bluebook-footer-blue);
            height: 50px; flex-shrink: 0; z-index: 10;
            border-top: 1px solid var(--bluebook-border-color);
        }
        .app-footer .footer-left { font-size: 0.875rem; font-weight: 600; color: var(--bluebook-text-color); }
        .app-footer .footer-center button { /* QNav button for test view */
            background-color: var(--bluebook-button-secondary-bg); color: white;
            padding: 0.5rem 1.25rem; border-radius: 9999px; border: none;
            cursor: pointer; font-weight: 600; font-size: 0.875rem;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .app-footer .footer-center button:hover { background-color: #374151; }
        .app-footer .footer-center button svg { width: 0.75rem; height: 0.75rem; }
        .app-footer .footer-right { display: flex; gap: 0.75rem; }
        .app-footer .nav-button {
            padding: 0.5rem 2rem; border-radius: 9999px; cursor: pointer;
            font-weight: 600; font-size: 0.875rem; border: none;
        }
        .app-footer .nav-button.primary { background-color: var(--bluebook-button-blue); color: white; }
        .app-footer .nav-button.primary:hover { background-color: #1d4ed8; }
        .app-footer .nav-button:disabled { background-color: #9ca3af; cursor: not-allowed; }

        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.6);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0s 0.3s;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.3s, visibility 0s; }
        .modal-content {
            background-color: white; border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 2.5rem; width: 90%; max-width: 45rem; text-align: center;
        }
        .modal-content h2 { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; }
        .modal-content p { font-size: 1rem; line-height: 1.6; color: var(--bluebook-light-text); margin-bottom: 2rem; }
        .modal-content p strong { color: var(--bluebook-text-color); }
        .modal-button {
            padding: 0.75rem 3rem; border-radius: 9999px; font-weight: bold; font-size: 1rem;
            cursor: pointer; border: none;
        }
        .modal-button.yellow { background-color: var(--bluebook-yellow-button); color: var(--bluebook-yellow-button-text); }
        .modal-button.yellow:hover { background-color: var(--bluebook-yellow-button-hover); }
        .modal-button.secondary { background-color: #e5e7eb; color: var(--bluebook-text-color); margin-right: 1rem; }
        .modal-button.secondary:hover { background-color: #d1d5db; }
        .qnav-popup {
            position: fixed; bottom: 0; left: 0; right: 0; background-color: white;
            border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1); z-index: 40; transform: translateY(100%);
            transition: transform 0.3s ease-in-out; padding: 1.5rem; max-width: 42rem; margin: 0 auto;
        }
        .qnav-popup.visible { transform: translateY(0); }
        .qnav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .qnav-header h3 { font-size: 1.125rem; font-weight: bold; margin: 0; }
        .qnav-close-btn { font-size: 1.5rem; color: var(--bluebook-light-text); cursor: pointer; background: none; border: none; padding: 0.25rem; }
        .qnav-legend {
            display: flex; justify-content: center; align-items: center; gap: 1.5rem;
            font-size: 0.75rem; color: var(--bluebook-light-text);
            padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px solid var(--bluebook-border-color);
        }
        .legend-item { display: flex; align-items: center; gap: 0.375rem; }
        .legend-icon { width: 0.625rem; height: 0.625rem; border-radius: 50%; }
        .legend-icon.current { background-color: var(--bluebook-button-blue); }
        .legend-icon.unanswered { border: 1.5px dashed var(--bluebook-border-color); }
        .legend-icon.for-review svg { width: 0.875rem; height: 0.875rem; color: var(--bluebook-red-flag); fill: var(--bluebook-red-flag); }
        .qnav-grid { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem; }
        .qnav-grid-btn {
            width: 2.5rem; height: 2.5rem; border-radius: 0.25rem; border: 1px solid var(--bluebook-border-color);
            background-color: white; color: var(--bluebook-text-color); font-weight: bold; font-size: 0.875rem;
            cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center;
        }
        .qnav-grid-btn:hover { background-color: #f3f4f6; }
        .qnav-grid-btn.current { border: 2px solid var(--bluebook-button-blue); background-color: var(--bluebook-selected-blue-bg); }
        .qnav-grid-btn.current .q-num-current-dot { width: 0.5rem; height: 0.5rem; background-color: var(--bluebook-button-blue); border-radius: 50%; }
        .qnav-grid-btn.unanswered { border-style: dashed; }
        .qnav-grid-btn .review-flag-icon { position: absolute; top: -0.3rem; right: -0.3rem; }
        .qnav-grid-btn .review-flag-icon svg { width: 1rem; height: 1rem; color: var(--bluebook-red-flag); fill: var(--bluebook-red-flag); stroke: white; stroke-width: 1.5px;}
        .qnav-review-page-btn {
            display: block; width: auto; margin: 0 auto; text-align: center; padding: 0.5rem 0;
            color: var(--bluebook-button-blue); font-weight: 600; font-size: 0.875rem;
            background: none; border: none; cursor: pointer; text-decoration: underline;
        }
        .qnav-review-page-btn:hover { text-decoration: none; }
        .more-menu-dropdown {
            position: absolute; top: calc(100% + 0.5rem); right: 0; background-color: white; border-radius: 0.375rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 20; width: 220px; overflow: hidden;
            opacity: 0; visibility: hidden; transform: translateY(-10px);
            transition: opacity 0.2s, transform 0.2s, visibility 0s 0.2s;
        }
        .more-menu-dropdown.visible { opacity: 1; visibility: visible; transform: translateY(0); transition: opacity 0.2s, transform 0.2s, visibility 0s; }
        .more-menu-item {
            display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem;
            font-size: 0.875rem; color: var(--bluebook-text-color); cursor: pointer;
        }
        .more-menu-item:hover { background-color: #f3f4f6; }
        .more-menu-item svg { width: 1.125rem; height: 1.125rem; color: var(--bluebook-light-text); }
        .more-menu-divider { height: 1px; background-color: var(--bluebook-border-color); margin: 0.25rem 0; }
        .confirm-checkbox-label {
            display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: var(--bluebook-text-color);
            margin-bottom: 1.5rem; cursor: pointer; text-align: left;
        }
        .confirm-checkbox-label input { margin-right: 0.5rem; width: 1rem; height: 1rem;}

        /* Home Screen Styles */
        .home-screen-view .app-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 1.5rem; background-color: var(--bluebook-header-blue-home); color: white;
            height: 60px; flex-shrink: 0;
        }
        .home-screen-view .logo { font-size: 1.5rem; font-weight: bold; }
        .home-screen-view .user-info { display: flex; align-items: center; gap: 0.75rem; font-size: 0.875rem;}
        .home-screen-view .user-avatar {
            width: 2rem; height: 2rem; border-radius: 50%;
            background-color: var(--bluebook-footer-blue); color: var(--bluebook-dark-blue);
            display: flex; align-items: center; justify-content: center; font-weight: bold;
        }
        .home-screen-view .main-home-content {
            flex-grow: 1; overflow-y: auto; padding: 2rem;
            background-color: var(--bluebook-home-bg);
        }
        .home-screen-view h1 { font-size: 2rem; font-weight: bold; margin-bottom: 0.25rem; }
        .home-screen-view .subtitle { font-size: 1rem; color: var(--bluebook-light-text); margin-bottom: 2.5rem; }
        .home-screen-view h2 { font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem; }
        .home-practice-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .home-practice-card {
            background-color: var(--bluebook-card-bg); padding: 1.5rem; border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07); display: flex; flex-direction: column;
        }
        .home-practice-card h3 { font-size: 1.125rem; font-weight: bold; margin-bottom: 0.5rem; }
        .home-practice-card p { font-size: 0.875rem; color: var(--bluebook-light-text); margin-bottom: 1rem; flex-grow: 1; }
        .home-practice-card .start-btn {
            background-color: var(--bluebook-button-blue); color: white; padding: 0.625rem 1.5rem; border-radius: 9999px;
            font-weight: 600; text-align: center; cursor: pointer; border: none; align-self: flex-start;
        }
        .home-practice-card .start-btn:hover { background-color: #1d4ed8; }
        .home-practice-card .start-btn.disabled { background-color: #9ca3af; cursor: not-allowed; }

        .fullscreen-transition-view {
            background-color: white; align-items: center; justify-content: center; text-align: center; padding: 2rem;
        }
        .fullscreen-transition-view h1 { font-size: 2.5rem; font-weight: bold; margin-bottom: 1rem; color: var(--bluebook-dark-blue); }
        .fullscreen-transition-view .message { font-size: 1.125rem; color: var(--bluebook-light-text); margin-bottom: 2rem; }
        .fullscreen-transition-view .spinner {
            border: 5px solid #f3f3f3; border-top: 5px solid var(--bluebook-button-blue);
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .finished-screen-content-box {
            background-color: white; padding: 2rem; border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 500px;
            border: 1px solid var(--bluebook-border-color); margin-top: 2rem;
        }
        .finished-screen-content-box .finished-img-placeholder { width: 120px; height: 120px; margin: 0 auto 1.5rem auto; border-radius:50%; background-color: #e0e7ff; display:flex; align-items:center; justify-content:center; font-size: 3rem;}
        .finished-screen-content-box .reminder { font-size: 0.875rem; margin-bottom: 1.5rem; }
        .finished-screen-content-box .test-day-msg { font-size: 0.875rem; color: var(--bluebook-light-text); margin-bottom: 2rem; }
        .finished-screen-view .return-home-btn {
             background-color: var(--bluebook-yellow-button); color: var(--bluebook-yellow-button-text);
             padding: 0.75rem 3rem; border-radius: 9999px; font-weight: bold; font-size: 1.125rem;
             cursor: pointer; border: none;
        }
        .finished-screen-view .return-home-btn:hover { background-color: var(--bluebook-yellow-button-hover); }
        #confetti-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;}

        .review-page-view .main-review-content {
            flex-grow: 1; overflow-y: auto; padding: 2rem; background-color: #f9fafb;
            display: flex; flex-direction: column; align-items: center;
        }
        .review-box {
            background-color: white; padding: 2rem; border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07); width: 100%; max-width: 800px;
        }
        .review-box h1 { font-size: 1.75rem; font-weight: bold; text-align: center; margin-bottom: 0.5rem;}
        .review-box .subtitle { text-align: center; color: var(--bluebook-light-text); margin-bottom: 1.5rem; font-size: 0.875rem;}
        .review-section-header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 1rem; margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--bluebook-border-color);
        }
        .review-section-header h2 { font-size: 1rem; font-weight: bold; margin:0; }
        .review-legend { display: flex; gap: 1rem; font-size: 0.75rem; color: var(--bluebook-light-text); }
        .review-legend .legend-item { display: flex; align-items: center; gap: 0.25rem; }
        .review-q-grid { display: flex; flex-wrap: wrap; gap: 0.75rem; }
    </style>
    <!-- MathJax Configuration -->
    <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      svg: {
        fontCache: 'global'
      }
    };
    </script>
    <script type="text/javascript" id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
    </script>
</head>
<body>
    <div class="app-wrapper">
        <!-- Home Screen View -->
        <div class="app-view home-screen-view active" id="home-view"> 
            <header class="app-header">
                <div class="logo">Bluebook</div>
                <div class="user-info">
                    <div class="user-avatar">SG</div>
                    <span>Sabir Ghias</span>
                </div>
            </header>
            <main class="main-home-content custom-scrollbar">
                <h1>Welcome, Sabir!</h1>
                <p class="subtitle">Good luck on test day!</p>
                <h2>Practice and Prepare</h2>
                <div class="home-practice-cards">
                    <div class="home-practice-card">
                        <h3>Test Preview</h3>
                        <p>A short set of example questions to help you get familiar with the app.</p>
                        <button class="start-btn" id="start-test-preview-btn">Start</button>
                    </div>
                    <div class="home-practice-card">
                        <h3>Full-Length Practice</h3>
                        <p>Simulate a full test experience with four timed sections.</p>
                        <button class="start-btn disabled" disabled>Coming Soon</button>
                    </div>
                </div>
            </main>
        </div>

        <!-- Test Interface View -->
        <div class="app-view test-interface-view" id="test-interface-view">
            <header class="app-header">
                <div class="header-left">
                    <div class="directions-btn" id="directions-btn">
                        <span class="section-title-header" id="section-title-header">Section 1: Reading & Writing</span>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                    </div>
                </div>
                <div class="header-center">
                    <div class="timer-display-container" id="timer-display-container">
                        <span class="timer-text" id="timer-text">0:00</span>
                        <svg id="timer-clock-icon" class="timer-icon hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        <button id="timer-toggle-btn" class="timer-toggle">[Hide]</button>
                    </div>
                </div>
                <div class="header-right">
                    <button class="header-icon-btn" id="highlights-notes-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22h6a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v10"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10.4 12.6a2 2 0 1 1 3.2 0l-1.6 3Z"/></svg>
                        <span>Highlights & Notes</span>
                    </button>
                    <button class="header-icon-btn hidden" id="calculator-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="8" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="16" y2="21"></line><line x1="3" y1="8" x2="21" y2="8"></line><line x1="3" y1="16" x2="21" y2="16"></line></svg>
                        <span>Calculator</span>
                    </button>
                     <button class="header-icon-btn hidden" id="reference-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
                        <span>Reference</span>
                    </button>
                    <div style="position: relative;">
                        <button class="header-icon-btn" id="more-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
                            <span>More</span>
                        </button>
                        <div class="more-menu-dropdown" id="more-menu-dropdown">
                            <div class="more-menu-item" id="more-help"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg> <span>Help</span> </div>
                            <div class="more-menu-item" id="more-shortcuts"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 100 20 10 10 0 000-20z"/><path d="M12 10a2 2 0 100-4 2 2 0 000 4zM12 12a2 2 0 100 4 2 2 0 000-4z"/></svg> <span>Shortcuts</span> </div>
                            <div class="more-menu-item" id="more-assistive-tech"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2c2.8 0 5 2.2 5 5s-2.2 5-5 5-5-2.2-5-5S9.2 2 12 2zm0 11c-2.8 0-5 2.2-5 5v2h10v-2c0-2.8-2.2-5-5-5z"/></svg> <span>Assistive Technology</span> </div>
                            <div class="more-menu-item" id="more-line-reader"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg> <span>Line Reader</span> </div>
                            <div class="more-menu-divider"></div>
                            <div class="more-menu-item" id="more-unscheduled-break"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg> <span>Unscheduled Break</span> </div>
                            <div class="more-menu-divider"></div>
                            <div class="more-menu-item" id="more-exit-exam"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg> <span>Exit the Exam</span> </div>
                        </div>
                    </div>
                </div>
            </header>
            <div class="test-preview-banner">THIS IS A TEST PREVIEW</div>
            <main class="main-content-area" id="main-content-area-dynamic">
                <div class="passage-pane custom-scrollbar" id="passage-pane"> <div class="passage-content" id="passage-content"></div> </div>
                <div class="spr-instructions-pane custom-scrollbar" id="spr-instructions-pane" style="display: none;"> <div class="spr-instructions-content" id="spr-instructions-content"></div> </div>
                <div class="pane-divider-draggable" id="pane-divider-draggable"></div>
                <div class="question-pane custom-scrollbar" id="question-pane">
                    <div class="question-header">
                        <div class="question-ident">
                            <div class="question-number-box" id="question-number-box-main">1</div>
                            <label class="mark-for-review-label"> <input type="checkbox" id="mark-review-checkbox-main"/> <svg id="flag-icon-main" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/></svg> <span>Mark for Review</span> </label>
                        </div>
                        <button class="cross-out-tool-btn" id="cross-out-tool-btn-main"> <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8.48 10.99C8.32 10.66 8 10.38 8 10C8 9.45 8.45 9 9 9C9.55 9 10 9.45 10 10C10 10.38 9.68 10.66 9.52 10.99H14.48C14.32 10.66 14 10.38 14 10C14 9.45 14.45 9 15 9C15.55 9 16 9.45 16 10C16 10.38 15.68 10.66 15.52 10.99H17C17.55 10.99 18 11.44 18 11.99C18 12.54 17.55 12.99 17 12.99H15.52C15.68 13.32 16 13.61 16 14C16 14.55 15.55 15 15 15C14.45 15 14 14.55 14 14C14 13.61 14.32 13.32 14.48 12.99H9.52C9.68 13.32 10 13.61 10 14C10 14.55 9.55 15 9 15C8.45 15 8 14.55 8 14C8 13.61 8.32 13.32 8.48 12.99H7C6.45 12.99 6 12.54 6 11.99C6 11.44 6.45 10.99 7 10.99H8.48Z" fill="currentColor"></path><path d="M3 5L21 19" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path></svg> <span>ABC</span> </button>
                    </div>
                    <div id="question-image-container-main" class="mb-4"> <img id="question-image-main" src="" alt="Question Image" class="max-w-full h-auto mx-auto hidden rounded-md border"> </div>
                    <div class="question-text" id="question-text-main"></div>
                    <div id="answer-area">
                        <div class="answer-options" id="answer-options-main"></div>
                        <div class="spr-input-container" id="spr-input-container-main" style="display: none;"> <input type="text" class="spr-input-field" id="spr-input-field-main" maxlength="6"> <div class="spr-answer-preview" id="spr-answer-preview-main">Answer Preview: </div> </div>
                    </div>
                </div>
            </main>
            <footer class="app-footer">
                <div class="footer-left" id="user-name-footer">Sabir Ghias</div>
                <div class="footer-center"> <button id="qNavBtnFooter"> <span>Question </span><span id="current-q-footer">1</span> of <span id="total-q-footer">0</span> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg> </button> </div>
                <div class="footer-right"> <button class="nav-button primary" id="back-btn-footer">Back</button> <button class="nav-button primary" id="next-btn-footer">Next</button> </div>
            </footer>
        </div>

        <!-- Module Over View -->
        <div class="app-view fullscreen-transition-view" id="module-over-view">
            <h1>This Module Is Over</h1>
            <p class="message">All your work has been saved.<br>You'll move on automatically in just a moment.</p>
            <div class="spinner"></div>
        </div>

        <!-- Finished Test View -->
        <div class="app-view fullscreen-transition-view" id="finished-view" style="z-index: 1;">
            <canvas id="confetti-canvas"></canvas>
            <div style="position: relative; z-index: 2;">
                <h1>You're All Finished!</h1>
                <div class="finished-screen-content-box">
                    <div class="finished-img-placeholder">ðŸ˜„</div>
                    <p class="reminder">Return to the homepage to start the preview again.<br><strong>Reminder:</strong> there are no scores or feedback in this preview.</p>
                    <p class="test-day-msg">When you see this page on test day, you'll know your scores have been submitted.</p>
                    <button class="return-home-btn" id="return-to-home-btn">Return to Home</button>
                </div>
            </div>
        </div>
        
        <!-- Review Page View -->
        <div class="app-view review-page-view" id="review-page-view">
            <header class="app-header">
                <div class="header-left"> <div class="directions-btn" id="review-directions-btn"> <span class="section-title-header" id="review-section-title-header">Section Review</span> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg> </div> </div>
                <div class="header-center"> <div class="timer-display-container" id="review-timer-display-container"> <span class="timer-text" id="review-timer-text">0:00</span> <svg id="review-timer-clock-icon" class="timer-icon hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <button id="review-timer-toggle-btn" class="timer-toggle">[Hide]</button> </div> </div>
                <div class="header-right"> </div>
            </header>
            <div class="test-preview-banner">THIS IS A TEST PREVIEW</div>
            <main class="main-review-content custom-scrollbar">
                <div class="review-box">
                    <h1>Check Your Work</h1>
                    <p class="subtitle">On test day, you wonâ€™t be able to move on to the next module until time expires.<br>For these practice questions, you can click Next when youâ€™re ready to move on.</p>
                    <div class="review-section-header">
                        <h2 id="review-page-section-name">Section 1: Reading and Writing Questions</h2>
                        <div class="review-legend">
                            <div class="legend-item"><span class="legend-icon unanswered" style="border: 1.5px dashed var(--bluebook-border-color);"></span> Unanswered</div>
                            <div class="legend-item"><span class="legend-icon for-review"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 1em; height: 1em; fill: var(--bluebook-red-flag);"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15" stroke="var(--bluebook-red-flag)" stroke-width="2"/></svg></span> For Review</div>
                        </div>
                    </div>
                    <div class="review-q-grid qnav-grid" id="review-page-qnav-grid">
                    </div>
                </div>
            </main>
            <footer class="app-footer">
                <div class="footer-left" id="review-user-name-footer">Sabir Ghias</div>
                <div class="footer-center"></div>
                <div class="footer-right"> <button class="nav-button primary" id="review-back-btn-footer">Back</button> <button class="nav-button primary" id="review-next-btn-footer">Next</button> </div>
            </footer>
        </div>

        <div id="modals-container">
            <div class="modal-overlay" id="directions-modal"> <div class="modal-content"> <h2 id="directions-modal-title"></h2> <p id="directions-modal-text"></p> <button class="modal-button yellow" id="directions-modal-close-btn">Close</button> </div> </div>
            <div class="qnav-popup" id="qnav-popup"> <div class="qnav-header"> <h3 id="qnav-title"></h3> <button class="qnav-close-btn" id="qnav-close-btn">Ã—</button> </div> <div class="qnav-legend"> <div class="legend-item"><span class="legend-icon current"></span> Current</div> <div class="legend-item"><span class="legend-icon unanswered"></span> Unanswered</div> <div class="legend-item"><span class="legend-icon for-review"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/></svg></span> For Review</div> </div> <div class="qnav-grid" id="qnav-grid-main"></div> <button class="qnav-review-page-btn" id="qnav-goto-review-btn">Go to Review Page</button> </div>
            <div class="modal-overlay" id="unscheduled-break-confirm-modal"> <div class="modal-content"> <h2>You'll Lose Testing Time During This Break</h2> <label class="confirm-checkbox-label"> <input type="checkbox" id="understand-lose-time-checkbox"> I need to take a break, and I understand that I'll lose testing time. </label> <p>If you're testing with a laptop, do not close it.</p> <div> <button class="modal-button secondary" id="unscheduled-break-cancel-btn">Cancel</button> <button class="modal-button yellow" id="unscheduled-break-confirm-btn" disabled>Take Unscheduled Break</button> </div> </div> </div>
            <div class="modal-overlay" id="exit-exam-confirm-modal"> <div class="modal-content" style="max-width: 35rem;"> <h2>Are You Sure You Want To Exit the Preview?</h2> <p>Test previews are not timed or scored, and your progress isnâ€™t saved. If you exit and come back, youâ€™ll start over.</p> <div> <button class="modal-button secondary" id="exit-exam-cancel-btn">Continue Test Preview</button> <button class="modal-button yellow" id="exit-exam-confirm-btn">Exit</button> </div> </div> </div>
        </div>

        <div class="calculator-overlay" id="calculator-overlay-main"> <div class="calculator-header" id="calculator-header-draggable"> <strong>Calculator</strong> <button class="calculator-close-btn" id="calculator-overlay-close-btn">Ã—</button> </div> <div class="calculator-body"> Desmos Calculator Placeholder </div> </div>
        <div class="reference-sheet-panel" id="reference-sheet-panel-main"> <div class="reference-header"> <h3>Reference</h3> <button class="reference-close-btn" id="reference-sheet-close-btn">Ã—</button> </div> <div class="reference-body"> <img src="https://i.postimg.cc/V6R7xL8k/sat-math-formula-sheet-sample.png" alt="Math Reference Sheet"> </div> </div>
    </div>

    <script>
        // --- Utility Functions (Define these FIRST) ---
        function toggleModal(modalElement, show) {
            if (!modalElement) { return; }
            modalElement.classList.toggle('visible', show);
        }

        // --- DATA STRUCTURES & CONFIG ---
        let currentQuizQuestions = []; 
        let currentTestFlow = [];      
        let questionLoadTime = 0; 

        const moduleMetadata = {
            "DT-T0-RW-M1": {
                name: "Reading & Writing - Module 1", type: "RW", 
                directions: "The questions in this section address a number of important reading and writing skills...",
                passageText: "<p>This is a placeholder passage for Reading & Writing Module 1. It is intentionally a bit long to test scrolling. Some say the world will end in fire, Some say in ice. From what Iâ€™ve tasted of desire I hold with those who favor fire. But if it had to perish twice, I think I know enough of hate To say that for destruction ice Is also great And would suffice. One more sentence to make it longer.</p><p>Another paragraph for the placeholder passage to ensure that the scrolling behavior of the passage pane can be observed if the content overflows. This passage does not directly relate to the questions but serves as a stand-in for actual passage-based reading content that would be used in a real test scenario for this module type.</p>",
                spr_directions: null, spr_examples_table: null
            },
            "DT-T0-MT-M1": { 
                name: "Math - Module 1", type: "Math",
                directions: "The questions in this section address a number of important math skills...",
                passageText: null,
                spr_directions: `<h3>Student-produced response directions</h3><ul><li>If you find <strong>more than one correct answer</strong>, enter only one answer.</li><li>You can enter up to 5 characters for a <strong>positive</strong> answer and up to 6 characters (including the negative sign) for a <strong>negative</strong> answer.</li><li>If your answer is a <strong>fraction</strong> that doesnâ€™t fit in the provided space, enter the decimal equivalent.</li><li>If your answer is a <strong>decimal</strong> that doesnâ€™t fit in the provided space, enter it by truncating or rounding at the fourth digit.</li><li>If your answer is a <strong>mixed number</strong> (such as 3 <span style="font-size: 0.7em; vertical-align: super;">1</span>/<span style="font-size: 0.7em; vertical-align: sub;">2</span>), enter it as an improper fraction (7/2) or its decimal equivalent (3.5).</li><li>Donâ€™t enter <strong>symbols</strong> such as a percent sign, comma, or dollar sign.</li></ul>`,
                spr_examples_table: `<table class="spr-examples-table"><thead><tr><th>Answer</th><th>Acceptable ways to enter answer</th><th>Unacceptable: will NOT receive credit</th></tr></thead><tbody><tr><td>3.5</td><td>3.5<br/>7/2</td><td>3 1/2</td></tr><tr><td>2/3</td><td>2/3<br/>.666<br/>.667</td><td>0.66<br/>0.67</td></tr><tr><td>-15</td><td>-15</td><td></td></tr></tbody></table>`
            }
        };
        const GITHUB_JSON_BASE_URL = 'https://raw.githubusercontent.com/ghiassabir/Bluebook-UI-UX-with-json-real-data-/main/data/json/';
        // IMPORTANT: Verify this base URL. If your images are in '.../data/images/', this needs to change.
        // Assuming images are in the SAME FOLDER as JSONs for now, or JSON `image_url` contains a relative path from the json folder.
        // If image_url in JSON is just "image.png", and it's in data/images/, then this should be:
        // const GITHUB_IMAGE_BASE_URL = 'https://raw.githubusercontent.com/ghiassabir/New-Approach-Quiz-and-Dashboard-11-june/main/data/images/';
        // For now, let's assume image_url in JSON might be relative like "../images/imagename.png" or a full path
        // OR that the image is in the same folder as the JSON.
        // For robustness, if image_url is JUST a filename, we might need a dedicated image base URL.
        // Let's assume for now that if image_url is relative, it's relative from the data/json/ folder.
        // A better robust solution for images would be needed if structure is complex.
        // For simplicity now, if image_url is just a filename, it will try to load from the json folder.
        // If image_url from JSON is like "images/myimage.png", it will try data/json/images/myimage.png
        const GITHUB_IMAGE_BASE_URL = GITHUB_JSON_BASE_URL; // Simplistic assumption, may need refinement based on actual image paths in JSON

        async function loadQuizData(quizName) {
            const url = `${GITHUB_JSON_BASE_URL}${quizName}.json`;
            console.log(`Fetching quiz data from: ${url}`);
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} for ${quizName}.json`);
                }
                const data = await response.json();
                if (!Array.isArray(data)) {
                    throw new Error(`Data for ${quizName}.json is not an array. Check JSON structure.`);
                }
                currentQuizQuestions = data;
                console.log(`Successfully loaded ${currentQuizQuestions.length} questions for quiz: ${quizName}`);
                return true;
            } catch (error) {
                console.error("Error loading quiz data:", error);
                // alert(`Failed to load quiz data for ${quizName}: ${error.message}. Please check the console and ensure the JSON file is accessible.`);
                currentQuizQuestions = [];
                return false;
            }
        }
        
        let currentView = 'home';
        let currentModuleIndex = 0;
        let currentQuestionNumber = 1; 
        let userAnswers = {}; 
        let isTimerHidden = false;
        let isCrossOutToolActive = false;
        let isHighlightingActive = false;

        const allAppViews = document.querySelectorAll('.app-view');
        const homeViewEl = document.getElementById('home-view');
        const testInterfaceViewEl = document.getElementById('test-interface-view');
        const moduleOverViewEl = document.getElementById('module-over-view');
        const finishedViewEl = document.getElementById('finished-view');
        const reviewPageViewEl = document.getElementById('review-page-view');
        const confettiCanvas = document.getElementById('confetti-canvas');
        const startTestPreviewBtn = document.getElementById('start-test-preview-btn');
        const returnToHomeBtn = document.getElementById('return-to-home-btn');
        const reviewPageSectionName = document.getElementById('review-page-section-name');
        const reviewPageQNavGrid = document.getElementById('review-page-qnav-grid');
        const reviewDirectionsBtn = document.getElementById('review-directions-btn');
        const reviewTimerText = document.getElementById('review-timer-text'); 
        const reviewTimerClockIcon = document.getElementById('review-timer-clock-icon'); 
        const reviewTimerToggleBtn = document.getElementById('review-timer-toggle-btn'); 
        const reviewBackBtnFooter = document.getElementById('review-back-btn-footer');
        const reviewNextBtnFooter = document.getElementById('review-next-btn-footer');
        const appWrapper = document.querySelector('.app-wrapper'); 
        const mainContentAreaDynamic = document.getElementById('main-content-area-dynamic');
        const passagePane = document.getElementById('passage-pane');
        const sprInstructionsPane = document.getElementById('spr-instructions-pane');
        const sprInstructionsContent = document.getElementById('spr-instructions-content');
        const paneDivider = document.getElementById('pane-divider-draggable');
        const questionPane = document.getElementById('question-pane');
        const highlightsNotesBtn = document.getElementById('highlights-notes-btn');
        const calculatorBtnHeader = document.getElementById('calculator-btn');
        const referenceBtnHeader = document.getElementById('reference-btn');
        const answerArea = document.getElementById('answer-area');
        const answerOptionsMainEl = document.getElementById('answer-options-main');
        const sprInputContainerMain = document.getElementById('spr-input-container-main');
        const sprInputFieldMain = document.getElementById('spr-input-field-main');
        const sprAnswerPreviewMain = document.getElementById('spr-answer-preview-main');
        const calculatorOverlay = document.getElementById('calculator-overlay-main');
        const calculatorHeaderDraggable = document.getElementById('calculator-header-draggable');
        const calculatorCloseBtn = document.getElementById('calculator-overlay-close-btn');
        const referenceSheetPanel = document.getElementById('reference-sheet-panel-main');
        const referenceSheetCloseBtn = document.getElementById('reference-sheet-close-btn');
        const crossOutToolBtnMain = document.getElementById('cross-out-tool-btn-main');
        const sectionTitleHeader = document.getElementById('section-title-header'); 
        const passageContentEl = document.getElementById('passage-content');
        const questionImageContainerMain = document.getElementById('question-image-container-main');
        const questionImageMain = document.getElementById('question-image-main');
        const questionTextMainEl = document.getElementById('question-text-main');
        const questionNumberBoxMainEl = document.getElementById('question-number-box-main');
        const markReviewCheckboxMain = document.getElementById('mark-review-checkbox-main');
        const flagIconMain = document.getElementById('flag-icon-main');
        const qNavBtnFooter = document.getElementById('qNavBtnFooter'); 
        const currentQFooterEl = document.getElementById('current-q-footer'); 
        const totalQFooterEl = document.getElementById('total-q-footer');
        const backBtnFooter = document.getElementById('back-btn-footer');
        const nextBtnFooter = document.getElementById('next-btn-footer');
        const directionsBtn = document.getElementById('directions-btn'); 
        const directionsModal = document.getElementById('directions-modal');
        const directionsModalTitle = document.getElementById('directions-modal-title');
        const directionsModalText = document.getElementById('directions-modal-text');
        const directionsModalCloseBtn = document.getElementById('directions-modal-close-btn');
        const qNavPopup = document.getElementById('qnav-popup');
        const qNavTitle = document.getElementById('qnav-title');
        const qNavGridMain = document.getElementById('qnav-grid-main');
        const qNavCloseBtn = document.getElementById('qnav-close-btn');
        const qNavGotoReviewBtn = document.getElementById('qnav-goto-review-btn');
        const timerTextEl = document.getElementById('timer-text'); 
        const timerClockIconEl = document.getElementById('timer-clock-icon');
        const timerToggleBtn = document.getElementById('timer-toggle-btn');
        const moreBtn = document.getElementById('more-btn'); 
        const moreMenuDropdown = document.getElementById('more-menu-dropdown');
        const moreUnscheduledBreakBtn = document.getElementById('more-unscheduled-break');
        const moreExitExamBtn = document.getElementById('more-exit-exam');
        const unscheduledBreakConfirmModal = document.getElementById('unscheduled-break-confirm-modal');
        const understandLoseTimeCheckbox = document.getElementById('understand-lose-time-checkbox');
        const unscheduledBreakConfirmBtn = document.getElementById('unscheduled-break-confirm-btn');
        const unscheduledBreakCancelBtn = document.getElementById('unscheduled-break-cancel-btn');
        const exitExamConfirmModal = document.getElementById('exit-exam-confirm-modal');
        const exitExamConfirmBtn = document.getElementById('exit-exam-confirm-btn');
        const exitExamCancelBtn = document.getElementById('exit-exam-cancel-btn');

        function getCurrentModule() { 
            if (currentTestFlow.length === 0 || !currentTestFlow[currentModuleIndex] || !moduleMetadata[currentTestFlow[currentModuleIndex]]) {
                return { name: "Error", type: "Error", directions: "Module data not found." };
            }
            return moduleMetadata[currentTestFlow[currentModuleIndex]]; 
        }

        function getCurrentQuestionData() {
             if (currentQuizQuestions.length === 0 || !currentQuizQuestions[currentQuestionNumber - 1]) {
                 return null; 
             }
             return currentQuizQuestions[currentQuestionNumber - 1];
        }

        function getAnswerStateKey(moduleIdx = currentModuleIndex, qNum = currentQuestionNumber) { 
            const questionData = (currentQuizQuestions && currentQuizQuestions.length > qNum -1) ? currentQuizQuestions[qNum - 1] : null;
            const qId = questionData ? questionData.question_id : `q${qNum}`;
            const quizName = (currentTestFlow && currentTestFlow.length > moduleIdx) ? currentTestFlow[moduleIdx] : 'unknownQuiz';
            return `${quizName}-${qId}`;
        }
        
        function getAnswerState(moduleIdx = currentModuleIndex, qNum = currentQuestionNumber) {
            const key = getAnswerStateKey(moduleIdx, qNum);
            if (!userAnswers[key]) {
                userAnswers[key] = { selected: null, spr_answer: '', marked: false, crossedOut: [], timeSpent: 0 };
            }
            return userAnswers[key];
        }

        function recordTimeSpent() {
            if (questionLoadTime === 0) return; 
            const answerState = getAnswerState(); 
            const timeSpentNow = (Date.now() - questionLoadTime) / 1000; 
            answerState.timeSpent = parseFloat((answerState.timeSpent + timeSpentNow).toFixed(2));
            questionLoadTime = 0; 
        }
        
        function populateQNavGrid() { /* ... (same as P2 correct version, uses getAnswerState, getCurrentModule) ... */ }
        function renderReviewPage() { /* ... (same as P2 correct version, uses getAnswerState, getCurrentModule) ... */ }
        function startConfetti() { /* ... (same as before) ... */ }
        function stopConfetti() { /* ... (same as before) ... */ }
        function handleTimerToggle(textEl, iconEl, btnEl) { /* ... (same as before) ... */ }
        
        function showView(viewId) {
            console.log("Switching to view:", viewId);
            currentView = viewId;
            allAppViews.forEach(view => view.classList.remove('active'));
            const targetView = document.getElementById(viewId);
            if (targetView) targetView.classList.add('active');
            else { console.error("View not found:", viewId); return; }

            if (viewId === 'test-interface-view') {
                if(qNavBtnFooter) qNavBtnFooter.style.display = 'flex';
                if(backBtnFooter) backBtnFooter.style.display = 'inline-block';
                if(nextBtnFooter) nextBtnFooter.style.display = 'inline-block';
                loadQuestion(); 
            } else if (viewId === 'review-page-view') {
                if(qNavBtnFooter) qNavBtnFooter.style.display = 'none';
                renderReviewPage();
            } else if (viewId === 'finished-view') {
                startConfetti();
            } else if (viewId === 'home-view') {
                stopConfetti();
                currentTestFlow = []; currentQuizQuestions = []; currentModuleIndex = 0; currentQuestionNumber = 1; userAnswers = {};
            }
            updateNavigation_OLD(); 
        }
        
        function loadQuestion() {
            if (!testInterfaceViewEl.classList.contains('active')) { return; }

            const moduleInfo = getCurrentModule();
            const questionData = getCurrentQuestionData();

            if (!moduleInfo || moduleInfo.type === "Error" || !questionData) {
                console.error("loadQuestion: Critical module or question data missing.");
                if (questionTextMainEl) questionTextMainEl.innerHTML = "<p>Error: Could not load question. Data missing.</p>";
                if (answerOptionsMainEl) answerOptionsMainEl.innerHTML = "";
                if (totalQFooterEl) totalQFooterEl.textContent = '0';
                 updateNavigation_OLD(); 
                return;
            }
            questionLoadTime = Date.now(); 
            const answerState = getAnswerState();

            const isMath = moduleInfo.type === "Math";
            if(highlightsNotesBtn) highlightsNotesBtn.classList.toggle('hidden', isMath);
            if(calculatorBtnHeader) calculatorBtnHeader.classList.toggle('hidden', !isMath);
            if(referenceBtnHeader) referenceBtnHeader.classList.toggle('hidden', !isMath);
            
            const isSPR = questionData.question_type === 'student_produced_response';
            if(crossOutToolBtnMain) crossOutToolBtnMain.classList.toggle('hidden', isSPR);

            if(sectionTitleHeader) sectionTitleHeader.textContent = `Section ${currentModuleIndex + 1}: ${moduleInfo.name}`;
            if(questionNumberBoxMainEl) questionNumberBoxMainEl.textContent = questionData.question_number || currentQuestionNumber;
            if(totalQFooterEl) totalQFooterEl.textContent = currentQuizQuestions.length;
            if(currentQFooterEl) currentQFooterEl.textContent = currentQuestionNumber;


            if(markReviewCheckboxMain) markReviewCheckboxMain.checked = answerState.marked;
            if(flagIconMain) {
                flagIconMain.style.fill = answerState.marked ? 'var(--bluebook-red-flag)' : 'none';
                flagIconMain.style.color = answerState.marked ? 'var(--bluebook-red-flag)' : '#9ca3af';
            }

            if(mainContentAreaDynamic) mainContentAreaDynamic.classList.toggle('cross-out-active', isCrossOutToolActive && !isSPR);
            if(crossOutToolBtnMain) crossOutToolBtnMain.classList.toggle('active', isCrossOutToolActive && !isSPR);

            // Reset layout classes and pane visibility
            mainContentAreaDynamic.classList.remove('single-pane', 'two-pane-spr');
            passagePane.style.display = 'none';
            sprInstructionsPane.style.display = 'none';
            paneDivider.style.display = 'none';
            if(passageContentEl) passageContentEl.innerHTML = ''; 
            if(sprInstructionsContent) sprInstructionsContent.innerHTML = ''; 
            if(answerOptionsMainEl) answerOptionsMainEl.style.display = 'none';
            if(sprInputContainerMain) sprInputContainerMain.style.display = 'none';
            if(questionImageMain) { questionImageMain.classList.add('hidden'); questionImageMain.src = ''; }


            if (isSPR) { 
                mainContentAreaDynamic.classList.add('two-pane-spr'); 
                if(sprInstructionsPane) sprInstructionsPane.style.display = 'flex';
                if(paneDivider) paneDivider.style.display = 'block';
                if(sprInstructionsContent) sprInstructionsContent.innerHTML = (moduleInfo.spr_directions || '') + (moduleInfo.spr_examples_table || '');
                if(questionTextMainEl) questionTextMainEl.innerHTML = questionData.question_text || '';
                if(sprInputContainerMain) sprInputContainerMain.style.display = 'block';
                if(sprInputFieldMain) sprInputFieldMain.value = answerState.spr_answer || '';
                if(sprAnswerPreviewMain) sprAnswerPreviewMain.textContent = `Answer Preview: ${answerState.spr_answer || ''}`;
            } else { 
                if(answerOptionsMainEl) answerOptionsMainEl.style.display = 'flex';
                if (moduleInfo.type === "RW" && moduleInfo.passageText) { 
                    if(passagePane) passagePane.style.display = 'flex'; // Ensure it's flex for proper rendering
                    if(paneDivider) paneDivider.style.display = 'block';
                    if(passageContentEl) passageContentEl.innerHTML = moduleInfo.passageText;
                    if(questionTextMainEl) questionTextMainEl.innerHTML = questionData.question_text || '';
                } else { 
                    mainContentAreaDynamic.classList.add('single-pane');
                    if(questionTextMainEl) questionTextMainEl.innerHTML = questionData.question_text || '';
                }

                if (questionData.image_url && questionImageMain && questionImageContainerMain) {
                    // Prepend base URL if image_url is relative
                    let fullImageUrl = questionData.image_url;
                    if (!questionData.image_url.startsWith('http://') && !questionData.image_url.startsWith('https://')) {
                        // Basic check if it's not an absolute URL. Assumes it's relative to GITHUB_IMAGE_BASE_URL
                        // If image_url might be like "../images/foo.png", this simple concatenation might be wrong.
                        // A more robust path joining might be needed if relative paths are complex.
                        // For now, this handles direct filenames correctly if GITHUB_IMAGE_BASE_URL points to the image dir.
                        fullImageUrl = GITHUB_IMAGE_BASE_URL + questionData.image_url;
                    }
                    questionImageMain.src = fullImageUrl; 
                    questionImageMain.alt = `Image for question ${questionData.question_number}`;
                    questionImageMain.classList.remove('hidden');
                }


                answerOptionsMainEl.innerHTML = ''; 
                const options = {};
                if (questionData.option_a !== undefined && questionData.option_a !== null) options['A'] = questionData.option_a;
                if (questionData.option_b !== undefined && questionData.option_b !== null) options['B'] = questionData.option_b;
                if (questionData.option_c !== undefined && questionData.option_c !== null) options['C'] = questionData.option_c;
                if (questionData.option_d !== undefined && questionData.option_d !== null) options['D'] = questionData.option_d;
                if (questionData.option_e !== undefined && questionData.option_e !== null) options['E'] = questionData.option_e;


                for (const [key, value] of Object.entries(options)) {
                    const isSelected = answerState.selected === key;
                    const isCrossedOut = answerState.crossedOut.includes(key);
                    
                    const containerDiv = document.createElement('div');
                    containerDiv.className = 'answer-option-container';
                    containerDiv.dataset.optionKey = key; 

                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'answer-option';
                    if (isSelected && !isCrossedOut) optionDiv.classList.add('selected');
                    if (isCrossedOut) optionDiv.classList.add('crossed-out');
                    
                    const answerLetterDiv = document.createElement('div');
                    answerLetterDiv.className = 'answer-letter';
                    answerLetterDiv.textContent = key;
                    
                    const answerTextSpan = document.createElement('span');
                    answerTextSpan.className = 'answer-text';
                    if (isCrossedOut) answerTextSpan.classList.add('text-dimmed-for-crossout');
                    answerTextSpan.innerHTML = value; 
                    
                    optionDiv.appendChild(answerLetterDiv);
                    optionDiv.appendChild(answerTextSpan);
                    containerDiv.appendChild(optionDiv);

                    if (isCrossOutToolActive && !isCrossedOut && !isSPR) {
                        const crossOutBtnIndividual = document.createElement('button');
                        crossOutBtnIndividual.className = 'individual-cross-out-btn';
                        crossOutBtnIndividual.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
                        crossOutBtnIndividual.title = `Cross out option ${key}`;
                        crossOutBtnIndividual.dataset.action = 'cross-out-individual';
                        containerDiv.appendChild(crossOutBtnIndividual);
                    } else if (isCrossedOut && !isSPR) { // Show Undo only if crossed out
                        const undoBtn = document.createElement('button');
                        undoBtn.className = 'undo-cross-out-btn';
                        undoBtn.textContent = 'Undo';
                        undoBtn.title = `Undo cross out for option ${key}`;
                        undoBtn.dataset.action = 'undo-cross-out';
                        containerDiv.appendChild(undoBtn);
                    }
                    answerOptionsMainEl.appendChild(containerDiv);
                }
            }
            
            if (typeof MathJax !== "undefined" && MathJax.typesetPromise) {
                MathJax.typesetPromise([passageContentEl, questionTextMainEl, answerOptionsMainEl, sprInstructionsContent]).catch(function (err) {
                    console.error('MathJax Typesetting Error:', err);
                });
            }
            updateNavigation_OLD();
        }
        
        // --- Event Listeners ---
        if(answerOptionsMainEl) answerOptionsMainEl.addEventListener('click', function(event) {
            let targetElement = event.target;
            const answerContainer = targetElement.closest('.answer-option-container');
            if (!answerContainer) return;

            const optionKey = answerContainer.dataset.optionKey;
            const actionButton = targetElement.closest('[data-action]');

            if (actionButton) {
                const action = actionButton.dataset.action;
                if (action === 'cross-out-individual') handleAnswerCrossOut(optionKey);
                else if (action === 'undo-cross-out') handleAnswerUndoCrossOut(optionKey);
            } else if (answerContainer.querySelector('.answer-option').contains(targetElement)) { 
                handleAnswerSelect(optionKey);
            }
        });

        function handleAnswerSelect(optionKey) {
            const answerState = getAnswerState();
            if (isCrossOutToolActive) { // If tool is active, clicking an option should cross it out
                if (!answerState.crossedOut.includes(optionKey)) {
                    handleAnswerCrossOut(optionKey);
                }
                return; 
            }
            // If tool is NOT active, and option is NOT crossed out, then select it
            if (!answerState.crossedOut.includes(optionKey)) {
                answerState.selected = optionKey;
                loadQuestion(); 
            }
        }

        function handleAnswerCrossOut(optionKey) {
             const answerState = getAnswerState();
             if (!answerState.crossedOut.includes(optionKey)) {
                 answerState.crossedOut.push(optionKey);
                 if (answerState.selected === optionKey) answerState.selected = null;
                 loadQuestion();
             }
        }
        function handleAnswerUndoCrossOut(optionKey) {
             const answerState = getAnswerState();
             answerState.crossedOut = answerState.crossedOut.filter(opt => opt !== optionKey);
             loadQuestion();
        }
        
        if(crossOutToolBtnMain) crossOutToolBtnMain.addEventListener('click', () => {
            const currentQData = getCurrentQuestionData();
            if (currentQData && currentQData.question_type === 'student_produced_response') return;
            isCrossOutToolActive = !isCrossOutToolActive;
            loadQuestion(); 
        });
        if(sprInputFieldMain) sprInputFieldMain.addEventListener('input', (event) => { 
            const answerState = getAnswerState();
            answerState.spr_answer = event.target.value;
            if(sprAnswerPreviewMain) sprAnswerPreviewMain.textContent = `Answer Preview: ${event.target.value}`;
        });

        function updateNavigation_OLD() { /* ... (Fix the ReferenceError if it was here) ... */ 
            // Make sure this function definition exists and is correctly named or removed if not used.
            // For Phase 2, this is a placeholder. Proper navigation in Phase 3.
            if (!currentTestFlow.length || !currentTestFlow[currentModuleIndex] || !currentQuizQuestions || currentQuizQuestions.length === 0 ) { 
                if(backBtnFooter) backBtnFooter.disabled = true;
                if(nextBtnFooter) nextBtnFooter.disabled = true;
                if(currentQFooterEl) currentQFooterEl.textContent = '0';
                if(totalQFooterEl) totalQFooterEl.textContent = '0';
                return;
            }
            const totalQuestionsInModule = currentQuizQuestions.length;
            if(currentQFooterEl) currentQFooterEl.textContent = currentQuestionNumber;
            if(totalQFooterEl) totalQFooterEl.textContent = totalQuestionsInModule;
            if(backBtnFooter) backBtnFooter.disabled = (currentQuestionNumber === 1);
            
            if(nextBtnFooter) {
                if (currentView === 'test-interface-view') {
                    nextBtnFooter.textContent = (currentQuestionNumber === totalQuestionsInModule) ? "Review Section" : "Next";
                    nextBtnFooter.disabled = false;
                } else if (currentView === 'review-page-view') {
                    nextBtnFooter.textContent = (currentModuleIndex === currentTestFlow.length - 1) ? "Finish Test" : "Next Module";
                    nextBtnFooter.disabled = false;
                } else { 
                     nextBtnFooter.textContent = "Next";
                     nextBtnFooter.disabled = true; 
                }
            }
        }
        // Ensure renderReviewPage does not call a non-existent updateNavigation
        function renderReviewPage() {
            if (!reviewPageViewEl || !reviewPageViewEl.classList.contains('active')) return;
            const moduleInfo = getCurrentModule();
            // ... (rest of renderReviewPage logic from previous correct version) ...
            updateNavigation_OLD(); // Use the correctly named old function
        }


        if(nextBtnFooter) nextBtnFooter.addEventListener('click', async () => { 
            recordTimeSpent(); 
            const totalQuestionsInModule = currentQuizQuestions.length;
            if (currentView === 'review-page-view') {
                console.log("Next button clicked on Review Page. Current Module Index:", currentModuleIndex, "Test Flow Length:", currentTestFlow.length);
                currentModuleIndex++;
                if (currentModuleIndex < currentTestFlow.length) {
                    console.log("Transitioning to next module. New index:", currentModuleIndex, "QuizName:", currentTestFlow[currentModuleIndex]);
                    showView('module-over-view'); 
                    await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate delay
                    
                    currentQuestionNumber = 1;
                    const success = await loadQuizData(currentTestFlow[currentModuleIndex]);
                    if(success && currentQuizQuestions.length > 0) {
                        console.log("Successfully loaded data for next module. Showing test interface.");
                        showView('test-interface-view');
                    } else {
                        console.error("Failed to load data for next module or no questions. Going home.");
                        showView('home-view'); 
                    }
                } else {
                    console.log("All modules completed. Showing finished view.");
                    showView('finished-view');
                }
            } else if (currentQuestionNumber < totalQuestionsInModule) {
                currentQuestionNumber++;
                isCrossOutToolActive = false; isHighlightingActive = false; if(highlightsNotesBtn) highlightsNotesBtn.classList.remove('active');
                loadQuestion();
            } else if (currentQuestionNumber === totalQuestionsInModule) {
                showView('review-page-view');
            }
        });
        if(backBtnFooter) backBtnFooter.addEventListener('click', () => { 
            recordTimeSpent(); 
             if (currentQuestionNumber > 1) {
                currentQuestionNumber--;
                isCrossOutToolActive = false; isHighlightingActive = false; if(highlightsNotesBtn) highlightsNotesBtn.classList.remove('active');
                loadQuestion();
            }
        });
        
        if(reviewDirectionsBtn) reviewDirectionsBtn.addEventListener('click', () => { /* ... */ });
        if(reviewTimerToggleBtn) reviewTimerToggleBtn.addEventListener('click', () => handleTimerToggle(reviewTimerText, reviewTimerClockIcon, reviewTimerToggleBtn));
        if(reviewBackBtnFooter) reviewBackBtnFooter.addEventListener('click', () => showView('test-interface-view') );

        if(startTestPreviewBtn) {
            startTestPreviewBtn.addEventListener('click', async () => {
                console.log("Start Test Preview button clicked.");
                currentModuleIndex = 0; currentQuestionNumber = 1; userAnswers = {};
                isTimerHidden = false; isCrossOutToolActive = false; isHighlightingActive = false;
                if(highlightsNotesBtn) highlightsNotesBtn.classList.remove('active');
                if(calculatorOverlay) calculatorOverlay.classList.remove('visible');
                if(referenceSheetPanel) referenceSheetPanel.classList.remove('visible');
                currentTestFlow = ["DT-T0-RW-M1", "DT-T0-MT-M1"]; 

                if (currentTestFlow.length > 0) {
                    const firstQuizName = currentTestFlow[currentModuleIndex];
                    startTestPreviewBtn.textContent = "Loading..."; startTestPreviewBtn.disabled = true;
                    const success = await loadQuizData(firstQuizName);
                    startTestPreviewBtn.textContent = "Start"; startTestPreviewBtn.disabled = false;
                    if (success && currentQuizQuestions.length > 0) {
                        showView('test-interface-view');
                    } else {
                        showView('home-view');
                    }
                } else {
                     showView('home-view'); // Go home if no test flow
                }
            });
        }
        if(returnToHomeBtn) returnToHomeBtn.addEventListener('click', () => showView('home-view'));
        
        if(calculatorBtnHeader) calculatorBtnHeader.addEventListener('click', () => toggleModal(calculatorOverlay, true));
        if(calculatorCloseBtn) calculatorCloseBtn.addEventListener('click', () => toggleModal(calculatorOverlay, false));
        if(referenceBtnHeader) referenceBtnHeader.addEventListener('click', () => toggleModal(referenceSheetPanel, true));
        if(referenceSheetCloseBtn) referenceSheetCloseBtn.addEventListener('click', () => toggleModal(referenceSheetPanel, false));
        
        let isCalcDragging = false; let currentX_calc_drag, currentY_calc_drag, initialX_calc_drag, initialY_calc_drag, xOffset_calc_drag = 0, yOffset_calc_drag = 0;
        if(calculatorHeaderDraggable) {
            calculatorHeaderDraggable.addEventListener('mousedown', (e) => { initialX_calc_drag = e.clientX - xOffset_calc_drag; initialY_calc_drag = e.clientY - yOffset_calc_drag; if (e.target === calculatorHeaderDraggable || e.target.tagName === 'STRONG') isCalcDragging = true; });
            document.addEventListener('mousemove', (e) => { if (isCalcDragging) { e.preventDefault(); currentX_calc_drag = e.clientX - initialX_calc_drag; currentY_calc_drag = e.clientY - initialY_calc_drag; xOffset_calc_drag = currentX_calc_drag; yOffset_calc_drag = currentY_calc_drag; if(calculatorOverlay) calculatorOverlay.style.transform = `translate3d(${currentX_calc_drag}px, ${currentY_calc_drag}px, 0)`;} });
            document.addEventListener('mouseup', () => isCalcDragging = false );
        }

        if(highlightsNotesBtn && passageContentEl) {
            highlightsNotesBtn.addEventListener('click', () => {
                isHighlightingActive = !isHighlightingActive;
                highlightsNotesBtn.classList.toggle('active', isHighlightingActive);
                mainContentAreaDynamic.classList.toggle('highlight-active', isHighlightingActive); 
                if (isHighlightingActive) {
                    passageContentEl.addEventListener('mouseup', handleTextSelection);
                } else {
                    passageContentEl.removeEventListener('mouseup', handleTextSelection);
                }
            });
        }
        function handleTextSelection() { /* ... (same as P2) ... */ }
        
        if(directionsBtn) directionsBtn.addEventListener('click', () => { /* ... (same as P2) ... */ });
        if(directionsModalCloseBtn) directionsModalCloseBtn.addEventListener('click', () => toggleModal(directionsModal, false));
        if(directionsModal) directionsModal.addEventListener('click', (e) => { if (e.target === directionsModal) toggleModal(directionsModal, false); });
        
        if(qNavBtnFooter) qNavBtnFooter.addEventListener('click', () => { populateQNavGrid(); toggleModal(qNavPopup, true); }); 
        if(qNavCloseBtn) qNavCloseBtn.addEventListener('click', () => toggleModal(qNavPopup, false));
        if(qNavGotoReviewBtn) qNavGotoReviewBtn.addEventListener('click', () => { toggleModal(qNavPopup, false); showView('review-page-view'); }); 
        
        if(markReviewCheckboxMain) markReviewCheckboxMain.addEventListener('change', () => {  /* ... (same as P2) ... */ });
        
        if(timerToggleBtn) timerToggleBtn.addEventListener('click', () => handleTimerToggle(timerTextEl, timerClockIconEl, timerToggleBtn));
        if(reviewTimerToggleBtn && reviewTimerText && reviewTimerClockIcon) reviewTimerToggleBtn.addEventListener('click', () => handleTimerToggle(reviewTimerText, reviewTimerClockIcon, reviewTimerToggleBtn));

        if(moreBtn) moreBtn.addEventListener('click', (e) => { e.stopPropagation(); if(moreMenuDropdown) moreMenuDropdown.classList.toggle('visible'); });
        document.body.addEventListener('click', (e) => { if (moreMenuDropdown && moreBtn && !moreBtn.contains(e.target) && !moreMenuDropdown.contains(e.target) && moreMenuDropdown.classList.contains('visible')) moreMenuDropdown.classList.remove('visible'); });
        if(moreMenuDropdown) moreMenuDropdown.addEventListener('click', (e) => e.stopPropagation()); 
        
        if(moreUnscheduledBreakBtn) moreUnscheduledBreakBtn.addEventListener('click', () => { /* ... (existing) ... */ });
        if(understandLoseTimeCheckbox) understandLoseTimeCheckbox.addEventListener('change', () => { /* ... (existing) ... */ });
        if(unscheduledBreakCancelBtn) unscheduledBreakCancelBtn.addEventListener('click', () => toggleModal(unscheduledBreakConfirmModal, false));
        if(unscheduledBreakConfirmBtn) unscheduledBreakConfirmBtn.addEventListener('click', () => { /* ... (existing) ... */ });
        
        if(moreExitExamBtn) moreExitExamBtn.addEventListener('click', () => { /* ... (existing) ... */ });
        if(exitExamCancelBtn) exitExamCancelBtn.addEventListener('click', () => toggleModal(exitExamConfirmModal, false));
        if(exitExamConfirmBtn) exitExamConfirmBtn.addEventListener('click', () => { /* ... (existing) ... */ });

    </script>
</body>
</html>
